<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访问次数分布分析工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            color: #666;
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-label {
            font-weight: 500;
            color: #555;
        }
        .stat-value {
            color: #667eea;
            font-weight: 600;
        }
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .progress {
            background: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #667eea;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .histogram {
            margin-top: 20px;
        }
        .histogram-bar {
            display: inline-block;
            background: #667eea;
            margin: 2px;
            vertical-align: bottom;
            color: white;
            font-size: 12px;
            text-align: center;
            min-width: 30px;
        }
        .analysis-note {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }
        .manual-data {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .manual-data textarea {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 访问次数分布分析工具</h1>
        
        <div style="text-align: center;">
            <button id="analyzeBtn" class="btn">开始分析近3天访问数据</button>
            <button id="exportBtn" class="btn" style="display: none;">导出数据</button>
        </div>

        <div id="loadingDiv" class="loading" style="display: none;">
            <div>正在分析Chrome历史记录...</div>
            <div class="progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText">准备中...</div>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div class="manual-data">
            <h4>📝 或输入模拟数据进行分析</h4>
            <p>如果Chrome历史记录权限不可用，您可以在下方输入模拟数据进行演示：</p>
            <textarea id="manualDataInput" placeholder="请输入数据格式：域名,访问次数（每行一个）
例如：
google.com,45
github.com,23
baidu.com,67
stackoverflow.com,12">google.com,45
github.com,23
baidu.com,67
stackoverflow.com,12
taobao.com,89
zhihu.com,34
weibo.com,56
qq.com,78
163.com,15
csdn.net,28
juejin.cn,19
v2ex.com,8
segmentfault.com,11
github.io,6
wikipedia.org,22
youtube.com,34
bilibili.com,41
douban.com,16
linkedin.com,9
twitter.com,13
facebook.com,7
instagram.com,5
reddit.com,18
medium.com,14
dev.to,3
hackernoon.com,2
techcrunch.com,4
nytimes.com,11
bbc.com,9
cnn.com,7
reuters.com,5
bloomberg.com,8
wsj.com,6
ft.com,4
economist.com,3
nature.com,12
science.com,9
harvard.edu,7
mit.edu,5
stanford.edu,4
berkeley.edu,3
cmu.edu,2
princeton.edu,1
yale.edu,1
columbia.edu,2
cornell.edu,1
upenn.edu,1
uchicago.edu,1
ucla.edu,2
umich.edu,1
uiuc.edu,1
gatech.edu,1
purdue.edu,1
utexas.edu,1
washington.edu,1
wisconsin.edu,1
psu.edu,1
osu.edu,1
umn.edu,1
ufl.edu,1
ucsd.edu,1
ucdavis.edu,1
ucsb.edu,1
ucirvine.edu,1
ucsc.edu,1
ucmerced.edu,1
ucr.edu,1
ucsf.edu,1
ucla.edu,1</textarea>
            <button id="analyzeManualBtn" class="btn">分析模拟数据</button>
        </div>

        <div id="resultsDiv" class="results" style="display: none;">
            <h2>📈 统计结果</h2>
            <div id="statsContainer"></div>
            
            <h3>📊 分布直方图</h3>
            <div id="histogramContainer" class="histogram"></div>
            
            <div class="analysis-note">
                <h4>💡 分析说明</h4>
                <ul>
                    <li>分析近3天内所有历史记录</li>
                    <li>按主域名聚合访问次数</li>
                    <li>排除Chrome内部页面和扩展页面</li>
                    <li>使用统计学方法分析分布特征</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let domainVisitData = new Map(); // 域名 -> 访问次数
        
        document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('analyzeManualBtn').addEventListener('click', analyzeManualData);

        async function startAnalysis() {
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            // 重置状态
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            analyzeBtn.disabled = true;
            
            domainVisitData.clear();
            
            try {
                await analyzeHistoryData();
                displayResults();
                
                resultsDiv.style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('分析失败:', error);
                errorDiv.textContent = `分析失败: ${error.message}`;
                errorDiv.style.display = 'block';
                
                // 显示手动输入选项
                document.querySelector('.manual-data').style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        async function analyzeManualData() {
            const input = document.getElementById('manualDataInput').value.trim();
            if (!input) {
                alert('请输入模拟数据');
                return;
            }
            
            domainVisitData.clear();
            
            try {
                const lines = input.split('\n');
                lines.forEach(line => {
                    const [domain, count] = line.split(',').map(s => s.trim());
                    if (domain && count && !isNaN(count)) {
                        domainVisitData.set(domain, parseInt(count));
                    }
                });
                
                if (domainVisitData.size === 0) {
                    alert('没有有效的数据，请检查格式');
                    return;
                }
                
                displayResults();
                document.getElementById('resultsDiv').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                
            } catch (error) {
                alert('数据解析失败，请检查格式');
            }
        }

        async function analyzeHistoryData() {
            // 检查是否有Chrome历史记录权限
            if (typeof chrome === 'undefined' || !chrome.history) {
                throw new Error('Chrome历史记录权限不可用，请使用下方模拟数据进行分析');
            }
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // 计算3天前的时间戳
            const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
            
            progressText.textContent = '正在获取历史记录...';
            progressBar.style.width = '20%';
            
            // 获取历史记录
            const historyResults = await new Promise((resolve, reject) => {
                chrome.history.search({
                    text: '',
                    startTime: threeDaysAgo,
                    maxResults: 100000
                }, (results) => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else {
                        resolve(results);
                    }
                });
            });

            progressText.textContent = `正在分析 ${historyResults.length} 条记录...`;
            progressBar.style.width = '50%';
            
            // 处理每一条历史记录
            for (let i = 0; i < historyResults.length; i++) {
                const item = historyResults[i];
                
                // 跳过特殊页面
                if (item.url.startsWith('chrome://') ||
                    item.url.startsWith('chrome-extension://') ||
                    item.url.startsWith('moz-extension://') ||
                    item.url.startsWith('edge://') ||
                    item.url.startsWith('about:')) {
                    continue;
                }
                
                // 提取主域名
                const mainDomain = extractMainDomain(item.url);
                if (!mainDomain) continue;
                
                // 更新访问次数
                domainVisitData.set(mainDomain, (domainVisitData.get(mainDomain) || 0) + 1);
                
                // 更新进度
                if (i % 1000 === 0) {
                    const progress = 50 + (i / historyResults.length) * 40;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `正在分析: ${i}/${historyResults.length} (${Math.round(i / historyResults.length * 100)}%)`;
                }
            }
            
            progressBar.style.width = '95%';
            progressText.textContent = '正在生成统计报告...';
            
            // 等待一下让用户看到完成状态
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        function extractMainDomain(url) {
            try {
                if (!url.match(/^https?:\/\//)) {
                    url = 'https://' + url;
                }
                const urlObj = new URL(url);
                const domainParts = urlObj.hostname.split('.');
                
                if (domainParts.length >= 2) {
                    return domainParts.slice(-2).join('.');
                }
                return urlObj.hostname;
            } catch (error) {
                return '';
            }
        }

        function displayResults() {
            const visitCounts = Array.from(domainVisitData.values()).sort((a, b) => a - b);
            
            // 基础统计
            const total = visitCounts.length;
            const sum = visitCounts.reduce((a, b) => a + b, 0);
            const mean = sum / total;
            const median = getMedian(visitCounts);
            const min = visitCounts[0];
            const max = visitCounts[visitCounts.length - 1];
            
            // 标准差
            const variance = visitCounts.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / total;
            const stdDev = Math.sqrt(variance);
            
            // 分位数
            const percentiles = {
                '10%': getPercentile(visitCounts, 10),
                '25%': getPercentile(visitCounts, 25),
                '50%': getPercentile(visitCounts, 50),
                '75%': getPercentile(visitCounts, 75),
                '90%': getPercentile(visitCounts, 90),
                '95%': getPercentile(visitCounts, 95)
            };
            
            // 显示统计信息
            displayStats({
                total,
                sum,
                mean: mean.toFixed(2),
                median,
                min,
                max,
                stdDev: stdDev.toFixed(2),
                percentiles
            });
            
            // 显示直方图
            displayHistogram(visitCounts);
            
            // 分析分布特征
            analyzeDistribution(visitCounts, mean, stdDev);
        }

        function displayStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">域名总数</span>
                    <span class="stat-value">${stats.total}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">总访问次数</span>
                    <span class="stat-value">${stats.sum}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">平均访问次数</span>
                    <span class="stat-value">${stats.mean}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">中位数</span>
                    <span class="stat-value">${stats.median}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">标准差</span>
                    <span class="stat-value">${stats.stdDev}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">最小值</span>
                    <span class="stat-value">${stats.min}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">最大值</span>
                    <span class="stat-value">${stats.max}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">10%分位数</span>
                    <span class="stat-value">${stats.percentiles['10%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">25%分位数</span>
                    <span class="stat-value">${stats.percentiles['25%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">75%分位数</span>
                    <span class="stat-value">${stats.percentiles['75%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">90%分位数</span>
                    <span class="stat-value">${stats.percentiles['90%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">95%分位数</span>
                    <span class="stat-value">${stats.percentiles['95%']}</span>
                </div>
            `;
        }

        function displayHistogram(visitCounts) {
            const container = document.getElementById('histogramContainer');
            
            // 创建频数分布
            const maxCount = Math.max(...visitCounts);
            const binSize = Math.ceil(maxCount / 20); // 20个区间
            const bins = Array(21).fill(0); // 0-20
            
            visitCounts.forEach(count => {
                const binIndex = Math.min(Math.floor(count / binSize), 20);
                bins[binIndex]++;
            });
            
            // 生成直方图HTML
            let html = '<div style="margin-bottom: 10px;"><strong>访问次数分布 (每区间宽度=' + binSize + ')</strong></div>';
            html += '<div style="white-space: nowrap; overflow-x: auto;">';
            
            const maxFreq = Math.max(...bins);
            bins.forEach((freq, index) => {
                if (freq > 0) {
                    const height = Math.max(20, (freq / maxFreq) * 100);
                    const rangeStart = index * binSize;
                    const rangeEnd = (index + 1) * binSize - 1;
                    
                    html += `<div class="histogram-bar" style="height: ${height}px;" title="${rangeStart}-${rangeEnd}次: ${freq}个域名">${freq}</div>`;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function analyzeDistribution(visitCounts, mean, stdDev) {
            const container = document.getElementById('resultsDiv');
            
            // 判断分布特征
            const skewness = calculateSkewness(visitCounts, mean, stdDev);
            const kurtosis = calculateKurtosis(visitCounts, mean, stdDev);
            
            let distributionType = '未知分布';
            let characteristics = [];
            
            if (skewness > 1) {
                distributionType = '右偏分布（正偏态）';
                characteristics.push('数据右偏，大部分域名访问次数较少');
            } else if (skewness < -1) {
                distributionType = '左偏分布（负偏态）';
                characteristics.push('数据左偏，大部分域名访问次数较多');
            } else {
                distributionType = '近似正态分布';
                characteristics.push('数据分布相对对称');
            }
            
            if (kurtosis > 3) {
                characteristics.push('尖峰分布，数据集中');
            } else if (kurtosis < 1) {
                characteristics.push('平峰分布，数据分散');
            }
            
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'analysis-note';
            analysisDiv.innerHTML = `
                <h4>📊 分布特征分析</h4>
                <p><strong>分布类型:</strong> ${distributionType}</p>
                <p><strong>偏度:</strong> ${skewness.toFixed(3)}</p>
                <p><strong>峰度:</strong> ${kurtosis.toFixed(3)}</p>
                <p><strong>特征描述:</strong> ${characteristics.join('；')}</p>
            `;
            container.appendChild(analysisDiv);
        }

        function getMedian(sortedArray) {
            const mid = Math.floor(sortedArray.length / 2);
            return sortedArray.length % 2 === 0 
                ? (sortedArray[mid - 1] + sortedArray[mid]) / 2 
                : sortedArray[mid];
        }

        function getPercentile(sortedArray, percentile) {
            const index = Math.ceil((percentile / 100) * sortedArray.length) - 1;
            return sortedArray[Math.max(0, Math.min(index, sortedArray.length - 1))];
        }

        function calculateSkewness(data, mean, stdDev) {
            const n = data.length;
            const skewness = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
            return skewness;
        }

        function calculateKurtosis(data, mean, stdDev) {
            const n = data.length;
            const kurtosis = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
            return kurtosis;
        }

        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                totalDomains: domainVisitData.size,
                domainVisitCounts: Object.fromEntries(domainVisitData),
                analysisDate: new Date().toLocaleDateString('zh-CN')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `domain-visit-analysis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>