<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¿é—®æ¬¡æ•°åˆ†å¸ƒåˆ†æå·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .btn:hover {
            background: #5a6fd8;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            text-align: center;
            color: #666;
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .stat-label {
            font-weight: 500;
            color: #555;
        }
        .stat-value {
            color: #667eea;
            font-weight: 600;
        }
        .error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .progress {
            background: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #667eea;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }
        .histogram {
            margin-top: 20px;
        }
        .histogram-bar {
            display: inline-block;
            background: #667eea;
            margin: 2px;
            vertical-align: bottom;
            color: white;
            font-size: 12px;
            text-align: center;
            min-width: 30px;
        }
        .analysis-note {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }
        .manual-data {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        .manual-data textarea {
            width: 100%;
            height: 150px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š è®¿é—®æ¬¡æ•°åˆ†å¸ƒåˆ†æå·¥å…·</h1>
        
        <div style="text-align: center;">
            <button id="analyzeBtn" class="btn">å¼€å§‹åˆ†æè¿‘3å¤©è®¿é—®æ•°æ®</button>
            <button id="exportBtn" class="btn" style="display: none;">å¯¼å‡ºæ•°æ®</button>
        </div>

        <div id="loadingDiv" class="loading" style="display: none;">
            <div>æ­£åœ¨åˆ†æChromeå†å²è®°å½•...</div>
            <div class="progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText">å‡†å¤‡ä¸­...</div>
        </div>

        <div id="errorDiv" class="error" style="display: none;"></div>

        <div class="manual-data">
            <h4>ğŸ“ æˆ–è¾“å…¥æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œåˆ†æ</h4>
            <p>å¦‚æœChromeå†å²è®°å½•æƒé™ä¸å¯ç”¨ï¼Œæ‚¨å¯ä»¥åœ¨ä¸‹æ–¹è¾“å…¥æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤ºï¼š</p>
            <textarea id="manualDataInput" placeholder="è¯·è¾“å…¥æ•°æ®æ ¼å¼ï¼šåŸŸå,è®¿é—®æ¬¡æ•°ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
ä¾‹å¦‚ï¼š
google.com,45
github.com,23
baidu.com,67
stackoverflow.com,12">google.com,45
github.com,23
baidu.com,67
stackoverflow.com,12
taobao.com,89
zhihu.com,34
weibo.com,56
qq.com,78
163.com,15
csdn.net,28
juejin.cn,19
v2ex.com,8
segmentfault.com,11
github.io,6
wikipedia.org,22
youtube.com,34
bilibili.com,41
douban.com,16
linkedin.com,9
twitter.com,13
facebook.com,7
instagram.com,5
reddit.com,18
medium.com,14
dev.to,3
hackernoon.com,2
techcrunch.com,4
nytimes.com,11
bbc.com,9
cnn.com,7
reuters.com,5
bloomberg.com,8
wsj.com,6
ft.com,4
economist.com,3
nature.com,12
science.com,9
harvard.edu,7
mit.edu,5
stanford.edu,4
berkeley.edu,3
cmu.edu,2
princeton.edu,1
yale.edu,1
columbia.edu,2
cornell.edu,1
upenn.edu,1
uchicago.edu,1
ucla.edu,2
umich.edu,1
uiuc.edu,1
gatech.edu,1
purdue.edu,1
utexas.edu,1
washington.edu,1
wisconsin.edu,1
psu.edu,1
osu.edu,1
umn.edu,1
ufl.edu,1
ucsd.edu,1
ucdavis.edu,1
ucsb.edu,1
ucirvine.edu,1
ucsc.edu,1
ucmerced.edu,1
ucr.edu,1
ucsf.edu,1
ucla.edu,1</textarea>
            <button id="analyzeManualBtn" class="btn">åˆ†ææ¨¡æ‹Ÿæ•°æ®</button>
        </div>

        <div id="resultsDiv" class="results" style="display: none;">
            <h2>ğŸ“ˆ ç»Ÿè®¡ç»“æœ</h2>
            <div id="statsContainer"></div>
            
            <h3>ğŸ“Š åˆ†å¸ƒç›´æ–¹å›¾</h3>
            <div id="histogramContainer" class="histogram"></div>
            
            <div class="analysis-note">
                <h4>ğŸ’¡ åˆ†æè¯´æ˜</h4>
                <ul>
                    <li>åˆ†æè¿‘3å¤©å†…æ‰€æœ‰å†å²è®°å½•</li>
                    <li>æŒ‰ä¸»åŸŸåèšåˆè®¿é—®æ¬¡æ•°</li>
                    <li>æ’é™¤Chromeå†…éƒ¨é¡µé¢å’Œæ‰©å±•é¡µé¢</li>
                    <li>ä½¿ç”¨ç»Ÿè®¡å­¦æ–¹æ³•åˆ†æåˆ†å¸ƒç‰¹å¾</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let domainVisitData = new Map(); // åŸŸå -> è®¿é—®æ¬¡æ•°
        
        document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('analyzeManualBtn').addEventListener('click', analyzeManualData);

        async function startAnalysis() {
            const loadingDiv = document.getElementById('loadingDiv');
            const errorDiv = document.getElementById('errorDiv');
            const resultsDiv = document.getElementById('resultsDiv');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            // é‡ç½®çŠ¶æ€
            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            analyzeBtn.disabled = true;
            
            domainVisitData.clear();
            
            try {
                await analyzeHistoryData();
                displayResults();
                
                resultsDiv.style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
            } catch (error) {
                console.error('åˆ†æå¤±è´¥:', error);
                errorDiv.textContent = `åˆ†æå¤±è´¥: ${error.message}`;
                errorDiv.style.display = 'block';
                
                // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
                document.querySelector('.manual-data').style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        }

        async function analyzeManualData() {
            const input = document.getElementById('manualDataInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥æ¨¡æ‹Ÿæ•°æ®');
                return;
            }
            
            domainVisitData.clear();
            
            try {
                const lines = input.split('\n');
                lines.forEach(line => {
                    const [domain, count] = line.split(',').map(s => s.trim());
                    if (domain && count && !isNaN(count)) {
                        domainVisitData.set(domain, parseInt(count));
                    }
                });
                
                if (domainVisitData.size === 0) {
                    alert('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                    return;
                }
                
                displayResults();
                document.getElementById('resultsDiv').style.display = 'block';
                document.getElementById('exportBtn').style.display = 'inline-block';
                
            } catch (error) {
                alert('æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
            }
        }

        async function analyzeHistoryData() {
            // æ£€æŸ¥æ˜¯å¦æœ‰Chromeå†å²è®°å½•æƒé™
            if (typeof chrome === 'undefined' || !chrome.history) {
                throw new Error('Chromeå†å²è®°å½•æƒé™ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œåˆ†æ');
            }
            
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            // è®¡ç®—3å¤©å‰çš„æ—¶é—´æˆ³
            const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000);
            
            progressText.textContent = 'æ­£åœ¨è·å–å†å²è®°å½•...';
            progressBar.style.width = '20%';
            
            // è·å–å†å²è®°å½•
            const historyResults = await new Promise((resolve, reject) => {
                chrome.history.search({
                    text: '',
                    startTime: threeDaysAgo,
                    maxResults: 100000
                }, (results) => {
                    if (chrome.runtime.lastError) {
                        reject(new Error(chrome.runtime.lastError.message));
                    } else {
                        resolve(results);
                    }
                });
            });

            progressText.textContent = `æ­£åœ¨åˆ†æ ${historyResults.length} æ¡è®°å½•...`;
            progressBar.style.width = '50%';
            
            // å¤„ç†æ¯ä¸€æ¡å†å²è®°å½•
            for (let i = 0; i < historyResults.length; i++) {
                const item = historyResults[i];
                
                // è·³è¿‡ç‰¹æ®Šé¡µé¢
                if (item.url.startsWith('chrome://') ||
                    item.url.startsWith('chrome-extension://') ||
                    item.url.startsWith('moz-extension://') ||
                    item.url.startsWith('edge://') ||
                    item.url.startsWith('about:')) {
                    continue;
                }
                
                // æå–ä¸»åŸŸå
                const mainDomain = extractMainDomain(item.url);
                if (!mainDomain) continue;
                
                // æ›´æ–°è®¿é—®æ¬¡æ•°
                domainVisitData.set(mainDomain, (domainVisitData.get(mainDomain) || 0) + 1);
                
                // æ›´æ–°è¿›åº¦
                if (i % 1000 === 0) {
                    const progress = 50 + (i / historyResults.length) * 40;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `æ­£åœ¨åˆ†æ: ${i}/${historyResults.length} (${Math.round(i / historyResults.length * 100)}%)`;
                }
            }
            
            progressBar.style.width = '95%';
            progressText.textContent = 'æ­£åœ¨ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š...';
            
            // ç­‰å¾…ä¸€ä¸‹è®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        function extractMainDomain(url) {
            try {
                if (!url.match(/^https?:\/\//)) {
                    url = 'https://' + url;
                }
                const urlObj = new URL(url);
                const domainParts = urlObj.hostname.split('.');
                
                if (domainParts.length >= 2) {
                    return domainParts.slice(-2).join('.');
                }
                return urlObj.hostname;
            } catch (error) {
                return '';
            }
        }

        function displayResults() {
            const visitCounts = Array.from(domainVisitData.values()).sort((a, b) => a - b);
            
            // åŸºç¡€ç»Ÿè®¡
            const total = visitCounts.length;
            const sum = visitCounts.reduce((a, b) => a + b, 0);
            const mean = sum / total;
            const median = getMedian(visitCounts);
            const min = visitCounts[0];
            const max = visitCounts[visitCounts.length - 1];
            
            // æ ‡å‡†å·®
            const variance = visitCounts.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / total;
            const stdDev = Math.sqrt(variance);
            
            // åˆ†ä½æ•°
            const percentiles = {
                '10%': getPercentile(visitCounts, 10),
                '25%': getPercentile(visitCounts, 25),
                '50%': getPercentile(visitCounts, 50),
                '75%': getPercentile(visitCounts, 75),
                '90%': getPercentile(visitCounts, 90),
                '95%': getPercentile(visitCounts, 95)
            };
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            displayStats({
                total,
                sum,
                mean: mean.toFixed(2),
                median,
                min,
                max,
                stdDev: stdDev.toFixed(2),
                percentiles
            });
            
            // æ˜¾ç¤ºç›´æ–¹å›¾
            displayHistogram(visitCounts);
            
            // åˆ†æåˆ†å¸ƒç‰¹å¾
            analyzeDistribution(visitCounts, mean, stdDev);
        }

        function displayStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">åŸŸåæ€»æ•°</span>
                    <span class="stat-value">${stats.total}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ€»è®¿é—®æ¬¡æ•°</span>
                    <span class="stat-value">${stats.sum}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡è®¿é—®æ¬¡æ•°</span>
                    <span class="stat-value">${stats.mean}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ä¸­ä½æ•°</span>
                    <span class="stat-value">${stats.median}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ ‡å‡†å·®</span>
                    <span class="stat-value">${stats.stdDev}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€å°å€¼</span>
                    <span class="stat-value">${stats.min}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æœ€å¤§å€¼</span>
                    <span class="stat-value">${stats.max}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">10%åˆ†ä½æ•°</span>
                    <span class="stat-value">${stats.percentiles['10%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">25%åˆ†ä½æ•°</span>
                    <span class="stat-value">${stats.percentiles['25%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">75%åˆ†ä½æ•°</span>
                    <span class="stat-value">${stats.percentiles['75%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">90%åˆ†ä½æ•°</span>
                    <span class="stat-value">${stats.percentiles['90%']}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">95%åˆ†ä½æ•°</span>
                    <span class="stat-value">${stats.percentiles['95%']}</span>
                </div>
            `;
        }

        function displayHistogram(visitCounts) {
            const container = document.getElementById('histogramContainer');
            
            // åˆ›å»ºé¢‘æ•°åˆ†å¸ƒ
            const maxCount = Math.max(...visitCounts);
            const binSize = Math.ceil(maxCount / 20); // 20ä¸ªåŒºé—´
            const bins = Array(21).fill(0); // 0-20
            
            visitCounts.forEach(count => {
                const binIndex = Math.min(Math.floor(count / binSize), 20);
                bins[binIndex]++;
            });
            
            // ç”Ÿæˆç›´æ–¹å›¾HTML
            let html = '<div style="margin-bottom: 10px;"><strong>è®¿é—®æ¬¡æ•°åˆ†å¸ƒ (æ¯åŒºé—´å®½åº¦=' + binSize + ')</strong></div>';
            html += '<div style="white-space: nowrap; overflow-x: auto;">';
            
            const maxFreq = Math.max(...bins);
            bins.forEach((freq, index) => {
                if (freq > 0) {
                    const height = Math.max(20, (freq / maxFreq) * 100);
                    const rangeStart = index * binSize;
                    const rangeEnd = (index + 1) * binSize - 1;
                    
                    html += `<div class="histogram-bar" style="height: ${height}px;" title="${rangeStart}-${rangeEnd}æ¬¡: ${freq}ä¸ªåŸŸå">${freq}</div>`;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function analyzeDistribution(visitCounts, mean, stdDev) {
            const container = document.getElementById('resultsDiv');
            
            // åˆ¤æ–­åˆ†å¸ƒç‰¹å¾
            const skewness = calculateSkewness(visitCounts, mean, stdDev);
            const kurtosis = calculateKurtosis(visitCounts, mean, stdDev);
            
            let distributionType = 'æœªçŸ¥åˆ†å¸ƒ';
            let characteristics = [];
            
            if (skewness > 1) {
                distributionType = 'å³ååˆ†å¸ƒï¼ˆæ­£åæ€ï¼‰';
                characteristics.push('æ•°æ®å³åï¼Œå¤§éƒ¨åˆ†åŸŸåè®¿é—®æ¬¡æ•°è¾ƒå°‘');
            } else if (skewness < -1) {
                distributionType = 'å·¦ååˆ†å¸ƒï¼ˆè´Ÿåæ€ï¼‰';
                characteristics.push('æ•°æ®å·¦åï¼Œå¤§éƒ¨åˆ†åŸŸåè®¿é—®æ¬¡æ•°è¾ƒå¤š');
            } else {
                distributionType = 'è¿‘ä¼¼æ­£æ€åˆ†å¸ƒ';
                characteristics.push('æ•°æ®åˆ†å¸ƒç›¸å¯¹å¯¹ç§°');
            }
            
            if (kurtosis > 3) {
                characteristics.push('å°–å³°åˆ†å¸ƒï¼Œæ•°æ®é›†ä¸­');
            } else if (kurtosis < 1) {
                characteristics.push('å¹³å³°åˆ†å¸ƒï¼Œæ•°æ®åˆ†æ•£');
            }
            
            const analysisDiv = document.createElement('div');
            analysisDiv.className = 'analysis-note';
            analysisDiv.innerHTML = `
                <h4>ğŸ“Š åˆ†å¸ƒç‰¹å¾åˆ†æ</h4>
                <p><strong>åˆ†å¸ƒç±»å‹:</strong> ${distributionType}</p>
                <p><strong>ååº¦:</strong> ${skewness.toFixed(3)}</p>
                <p><strong>å³°åº¦:</strong> ${kurtosis.toFixed(3)}</p>
                <p><strong>ç‰¹å¾æè¿°:</strong> ${characteristics.join('ï¼›')}</p>
            `;
            container.appendChild(analysisDiv);
        }

        function getMedian(sortedArray) {
            const mid = Math.floor(sortedArray.length / 2);
            return sortedArray.length % 2 === 0 
                ? (sortedArray[mid - 1] + sortedArray[mid]) / 2 
                : sortedArray[mid];
        }

        function getPercentile(sortedArray, percentile) {
            const index = Math.ceil((percentile / 100) * sortedArray.length) - 1;
            return sortedArray[Math.max(0, Math.min(index, sortedArray.length - 1))];
        }

        function calculateSkewness(data, mean, stdDev) {
            const n = data.length;
            const skewness = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 3), 0) / n;
            return skewness;
        }

        function calculateKurtosis(data, mean, stdDev) {
            const n = data.length;
            const kurtosis = data.reduce((acc, val) => acc + Math.pow((val - mean) / stdDev, 4), 0) / n;
            return kurtosis;
        }

        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                totalDomains: domainVisitData.size,
                domainVisitCounts: Object.fromEntries(domainVisitData),
                analysisDate: new Date().toLocaleDateString('zh-CN')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `domain-visit-analysis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>