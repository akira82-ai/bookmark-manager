<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½æ£€æµ‹åŠŸèƒ½æµ‹è¯•</title>
  <link rel="stylesheet" href="bookmarks.css">
  <style>
    body {
      padding: 20px;
      background: #f5f7fa;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .test-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #2c3e50;
    }
    .test-section {
      margin-bottom: 2rem;
    }
    .test-section h3 {
      color: #667eea;
      margin-bottom: 1rem;
    }
    .test-bookmarks {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .test-log {
      background: #f8f9fa;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.25rem;
    }
    .log-info { color: #667eea; }
    .log-success { color: #28a745; }
    .log-warning { color: #ffc107; }
    .log-error { color: #dc3545; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">ğŸ” æ™ºèƒ½æ£€æµ‹åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="toolbar-container">
      <div class="toolbar-section">
        <div class="toolbar-group">
          <button id="test-check-btn" class="toolbar-btn">
            <span class="toolbar-icon">ğŸ”</span>
            <span class="toolbar-text">å¼€å§‹æµ‹è¯•</span>
          </button>
          <button id="test-exit-btn" class="toolbar-btn">
            <span class="toolbar-icon">â†©ï¸</span>
            <span class="toolbar-text">é€€å‡ºæµ‹è¯•</span>
          </button>
          <button id="test-clear-btn" class="toolbar-btn">
            <span class="toolbar-icon">ğŸ—‘ï¸</span>
            <span class="toolbar-text">æ¸…ç©ºæ—¥å¿—</span>
          </button>
        </div>
      </div>
      
      <div id="test-progress" class="progress-container" style="display: none;">
        <div class="progress-header">
          <span class="progress-title">æµ‹è¯•è¿›è¡Œä¸­...</span>
          <div class="progress-stats">
            <span id="test-progress-count">0/0</span>
            <span id="test-progress-percent">(0%)</span>
          </div>
        </div>
        <div class="progress-bar">
          <div id="test-progress-fill" class="progress-fill"></div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h3>æµ‹è¯•ä¹¦ç­¾</h3>
      <div id="test-bookmarks" class="test-bookmarks">
        <!-- æµ‹è¯•ä¹¦ç­¾å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
      </div>
    </div>

    <div class="test-section">
      <h3>æµ‹è¯•æ—¥å¿—</h3>
      <div id="test-log" class="test-log">
        <div class="log-entry log-info">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
      </div>
    </div>
  </div>

  <script src="bookmarks.js"></script>
  <script>
    // æµ‹è¯•æ•°æ®
    const testBookmarks = [
      { id: 'test1', title: 'Google', url: 'https://www.google.com' },
      { id: 'test2', title: 'GitHub', url: 'https://github.com' },
      { id: 'test3', title: 'æ— æ•ˆé“¾æ¥æµ‹è¯•', url: 'https://this-domain-does-not-exist-12345.com' },
      { id: 'test4', title: 'Stack Overflow', url: 'https://stackoverflow.com' },
      { id: 'test5', title: 'è¶…æ—¶æµ‹è¯•', url: 'https://httpstat.us/200?sleep=5000' }
    ];

    class TestManager {
      constructor() {
        this.linkChecker = new LinkChecker();
        this.testResults = new Map();
        this.isTesting = false;
        this.init();
      }

      init() {
        this.renderTestBookmarks();
        this.bindEvents();
        this.log('æµ‹è¯•ç®¡ç†å™¨å·²åˆå§‹åŒ–', 'info');
      }

      bindEvents() {
        document.getElementById('test-check-btn').addEventListener('click', () => {
          this.startTest();
        });

        document.getElementById('test-exit-btn').addEventListener('click', () => {
          this.exitTestMode();
        });

        document.getElementById('test-clear-btn').addEventListener('click', () => {
          this.clearLog();
        });
      }

      renderTestBookmarks() {
        const container = document.getElementById('test-bookmarks');
        container.innerHTML = '';

        testBookmarks.forEach(bookmark => {
          const card = this.createTestCard(bookmark);
          container.appendChild(card);
        });
      }

      createTestCard(bookmark) {
        const card = document.createElement('div');
        card.className = 'bookmark-card';
        card.dataset.testId = bookmark.id;
        card.innerHTML = `
          <div class="bookmark-header">
            <div class="bookmark-title">${bookmark.title}</div>
          </div>
          <div class="bookmark-url">${bookmark.url}</div>
          <div class="bookmark-actions">
            <button class="bookmark-action-btn test-btn">æµ‹è¯•</button>
          </div>
        `;

        card.querySelector('.test-btn').addEventListener('click', () => {
          this.testSingleBookmark(bookmark);
        });

        return card;
      }

      async startTest() {
        if (this.isTesting) {
          this.log('æµ‹è¯•æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...', 'warning');
          return;
        }

        this.isTesting = true;
        this.testResults.clear();
        this.showProgress();
        this.log('å¼€å§‹æ‰¹é‡æµ‹è¯•...', 'info');

        try {
          const batchProcessor = new BatchProcessor(2);
          
          await batchProcessor.process(testBookmarks, async (bookmark) => {
            this.log(`æ­£åœ¨æµ‹è¯•: ${bookmark.title}`, 'info');
            const result = await this.linkChecker.check(bookmark.url);
            this.processTestResult(bookmark, result);
            this.updateTestCard(bookmark.id, result);
            this.updateProgress();
          });

          this.log('æ‰¹é‡æµ‹è¯•å®Œæˆï¼', 'success');
          this.showTestResults();

        } catch (error) {
          this.log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        } finally {
          this.isTesting = false;
          setTimeout(() => {
            document.getElementById('test-progress').style.display = 'none';
          }, 2000);
        }
      }

      async testSingleBookmark(bookmark) {
        this.log(`å•ç‹¬æµ‹è¯•: ${bookmark.title}`, 'info');
        try {
          const result = await this.linkChecker.check(bookmark.url);
          this.processTestResult(bookmark, result);
          this.updateTestCard(bookmark.id, result);
          this.log(`æµ‹è¯•å®Œæˆ: ${bookmark.title} - ${result.status}`, 'success');
        } catch (error) {
          this.log(`æµ‹è¯•å¤±è´¥: ${bookmark.title} - ${error.message}`, 'error');
        }
      }

      processTestResult(bookmark, result) {
        this.testResults.set(bookmark.id, {
          ...bookmark,
          ...result,
          testedAt: Date.now()
        });
      }

      updateTestCard(bookmarkId, result) {
        const card = document.querySelector(`[data-test-id="${bookmarkId}"]`);
        if (!card) return;

        // ç§»é™¤æ£€æµ‹çŠ¶æ€ç±»
        card.classList.remove('checking');
        
        let statusBadge = card.querySelector('.status-badge');
        if (!statusBadge) {
          statusBadge = document.createElement('div');
          statusBadge.className = 'status-badge';
          card.appendChild(statusBadge);
        }

        statusBadge.className = `status-badge ${result.status}`;
        const statusTexts = {
          valid: 'æœ‰æ•ˆ',
          invalid: 'æ— æ•ˆ', 
          redirect: 'é‡å®šå‘',
          timeout: 'è¶…æ—¶'
        };
        statusBadge.textContent = statusTexts[result.status] || 'æœªçŸ¥';
      }

      showProgress() {
        document.getElementById('test-progress').style.display = 'block';
        document.getElementById('test-progress-count').textContent = `0/${testBookmarks.length}`;
        document.getElementById('test-progress-percent').textContent = '(0%)';
        document.getElementById('test-progress-fill').style.width = '0%';
      }

      updateProgress() {
        const processed = this.testResults.size;
        const total = testBookmarks.length;
        const percentage = Math.round((processed / total) * 100);

        document.getElementById('test-progress-count').textContent = `${processed}/${total}`;
        document.getElementById('test-progress-percent').textContent = `(${percentage}%)`;
        document.getElementById('test-progress-fill').style.width = `${percentage}%`;
      }

      showTestResults() {
        const results = Array.from(this.testResults.values());
        const stats = {
          valid: results.filter(r => r.status === 'valid').length,
          invalid: results.filter(r => r.status === 'invalid').length,
          redirect: results.filter(r => r.status === 'redirect').length,
          timeout: results.filter(r => r.status === 'timeout').length
        };

        this.log(`æµ‹è¯•ç»“æœç»Ÿè®¡:`, 'info');
        this.log(`âœ… æœ‰æ•ˆ: ${stats.valid}`, 'success');
        this.log(`âŒ æ— æ•ˆ: ${stats.invalid}`, 'error');
        this.log(`âš ï¸ é‡å®šå‘: ${stats.redirect}`, 'warning');
        this.log(`â° è¶…æ—¶: ${stats.timeout}`, 'warning');
      }

      log(message, type = 'info') {
        const logContainer = document.getElementById('test-log');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      exitTestMode() {
        // æ¸…é™¤æ‰€æœ‰çŠ¶æ€æ ‡ç­¾
        const cards = document.querySelectorAll('[data-test-id]');
        cards.forEach(card => {
          // ç§»é™¤çŠ¶æ€ç±»
          card.classList.remove('checking');
          
          // ç§»é™¤çŠ¶æ€æ ‡ç­¾
          const statusBadge = card.querySelector('.status-badge');
          if (statusBadge) {
            statusBadge.remove();
          }
        });

        // æ¸…ç©ºæµ‹è¯•ç»“æœ
        this.testResults.clear();

        this.log('å·²é€€å‡ºæµ‹è¯•æ¨¡å¼ï¼Œæ¸…é™¤æ‰€æœ‰æ£€æµ‹çŠ¶æ€', 'info');
      }

      clearLog() {
        const logContainer = document.getElementById('test-log');
        logContainer.innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
      }
    }

    // åˆå§‹åŒ–æµ‹è¯•ç®¡ç†å™¨
    let testManager;
    document.addEventListener('DOMContentLoaded', () => {
      testManager = new TestManager();
    });
  </script>
</body>
</html>