<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能检测功能测试</title>
  <link rel="stylesheet" href="bookmarks.css">
  <style>
    body {
      padding: 20px;
      background: #f5f7fa;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .test-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: #2c3e50;
    }
    .test-section {
      margin-bottom: 2rem;
    }
    .test-section h3 {
      color: #667eea;
      margin-bottom: 1rem;
    }
    .test-bookmarks {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .test-log {
      background: #f8f9fa;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.25rem;
    }
    .log-info { color: #667eea; }
    .log-success { color: #28a745; }
    .log-warning { color: #ffc107; }
    .log-error { color: #dc3545; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1 class="test-title">🔍 智能检测功能测试</h1>
    
    <div class="toolbar-container">
      <div class="toolbar-section">
        <div class="toolbar-group">
          <button id="test-check-btn" class="toolbar-btn">
            <span class="toolbar-icon">🔍</span>
            <span class="toolbar-text">开始测试</span>
          </button>
          <button id="test-exit-btn" class="toolbar-btn">
            <span class="toolbar-icon">↩️</span>
            <span class="toolbar-text">退出测试</span>
          </button>
          <button id="test-clear-btn" class="toolbar-btn">
            <span class="toolbar-icon">🗑️</span>
            <span class="toolbar-text">清空日志</span>
          </button>
        </div>
      </div>
      
      <div id="test-progress" class="progress-container" style="display: none;">
        <div class="progress-header">
          <span class="progress-title">测试进行中...</span>
          <div class="progress-stats">
            <span id="test-progress-count">0/0</span>
            <span id="test-progress-percent">(0%)</span>
          </div>
        </div>
        <div class="progress-bar">
          <div id="test-progress-fill" class="progress-fill"></div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h3>测试书签</h3>
      <div id="test-bookmarks" class="test-bookmarks">
        <!-- 测试书签将在这里生成 -->
      </div>
    </div>

    <div class="test-section">
      <h3>测试日志</h3>
      <div id="test-log" class="test-log">
        <div class="log-entry log-info">等待开始测试...</div>
      </div>
    </div>
  </div>

  <script src="bookmarks.js"></script>
  <script>
    // 测试数据
    const testBookmarks = [
      { id: 'test1', title: 'Google', url: 'https://www.google.com' },
      { id: 'test2', title: 'GitHub', url: 'https://github.com' },
      { id: 'test3', title: '无效链接测试', url: 'https://this-domain-does-not-exist-12345.com' },
      { id: 'test4', title: 'Stack Overflow', url: 'https://stackoverflow.com' },
      { id: 'test5', title: '超时测试', url: 'https://httpstat.us/200?sleep=5000' }
    ];

    class TestManager {
      constructor() {
        this.linkChecker = new LinkChecker();
        this.testResults = new Map();
        this.isTesting = false;
        this.init();
      }

      init() {
        this.renderTestBookmarks();
        this.bindEvents();
        this.log('测试管理器已初始化', 'info');
      }

      bindEvents() {
        document.getElementById('test-check-btn').addEventListener('click', () => {
          this.startTest();
        });

        document.getElementById('test-exit-btn').addEventListener('click', () => {
          this.exitTestMode();
        });

        document.getElementById('test-clear-btn').addEventListener('click', () => {
          this.clearLog();
        });
      }

      renderTestBookmarks() {
        const container = document.getElementById('test-bookmarks');
        container.innerHTML = '';

        testBookmarks.forEach(bookmark => {
          const card = this.createTestCard(bookmark);
          container.appendChild(card);
        });
      }

      createTestCard(bookmark) {
        const card = document.createElement('div');
        card.className = 'bookmark-card';
        card.dataset.testId = bookmark.id;
        card.innerHTML = `
          <div class="bookmark-header">
            <div class="bookmark-title">${bookmark.title}</div>
          </div>
          <div class="bookmark-url">${bookmark.url}</div>
          <div class="bookmark-actions">
            <button class="bookmark-action-btn test-btn">测试</button>
          </div>
        `;

        card.querySelector('.test-btn').addEventListener('click', () => {
          this.testSingleBookmark(bookmark);
        });

        return card;
      }

      async startTest() {
        if (this.isTesting) {
          this.log('测试正在进行中，请稍候...', 'warning');
          return;
        }

        this.isTesting = true;
        this.testResults.clear();
        this.showProgress();
        this.log('开始批量测试...', 'info');

        try {
          const batchProcessor = new BatchProcessor(2);
          
          await batchProcessor.process(testBookmarks, async (bookmark) => {
            this.log(`正在测试: ${bookmark.title}`, 'info');
            const result = await this.linkChecker.check(bookmark.url);
            this.processTestResult(bookmark, result);
            this.updateTestCard(bookmark.id, result);
            this.updateProgress();
          });

          this.log('批量测试完成！', 'success');
          this.showTestResults();

        } catch (error) {
          this.log(`测试失败: ${error.message}`, 'error');
        } finally {
          this.isTesting = false;
          setTimeout(() => {
            document.getElementById('test-progress').style.display = 'none';
          }, 2000);
        }
      }

      async testSingleBookmark(bookmark) {
        this.log(`单独测试: ${bookmark.title}`, 'info');
        try {
          const result = await this.linkChecker.check(bookmark.url);
          this.processTestResult(bookmark, result);
          this.updateTestCard(bookmark.id, result);
          this.log(`测试完成: ${bookmark.title} - ${result.status}`, 'success');
        } catch (error) {
          this.log(`测试失败: ${bookmark.title} - ${error.message}`, 'error');
        }
      }

      processTestResult(bookmark, result) {
        this.testResults.set(bookmark.id, {
          ...bookmark,
          ...result,
          testedAt: Date.now()
        });
      }

      updateTestCard(bookmarkId, result) {
        const card = document.querySelector(`[data-test-id="${bookmarkId}"]`);
        if (!card) return;

        // 移除检测状态类
        card.classList.remove('checking');
        
        let statusBadge = card.querySelector('.status-badge');
        if (!statusBadge) {
          statusBadge = document.createElement('div');
          statusBadge.className = 'status-badge';
          card.appendChild(statusBadge);
        }

        statusBadge.className = `status-badge ${result.status}`;
        const statusTexts = {
          valid: '有效',
          invalid: '无效', 
          redirect: '重定向',
          timeout: '超时'
        };
        statusBadge.textContent = statusTexts[result.status] || '未知';
      }

      showProgress() {
        document.getElementById('test-progress').style.display = 'block';
        document.getElementById('test-progress-count').textContent = `0/${testBookmarks.length}`;
        document.getElementById('test-progress-percent').textContent = '(0%)';
        document.getElementById('test-progress-fill').style.width = '0%';
      }

      updateProgress() {
        const processed = this.testResults.size;
        const total = testBookmarks.length;
        const percentage = Math.round((processed / total) * 100);

        document.getElementById('test-progress-count').textContent = `${processed}/${total}`;
        document.getElementById('test-progress-percent').textContent = `(${percentage}%)`;
        document.getElementById('test-progress-fill').style.width = `${percentage}%`;
      }

      showTestResults() {
        const results = Array.from(this.testResults.values());
        const stats = {
          valid: results.filter(r => r.status === 'valid').length,
          invalid: results.filter(r => r.status === 'invalid').length,
          redirect: results.filter(r => r.status === 'redirect').length,
          timeout: results.filter(r => r.status === 'timeout').length
        };

        this.log(`测试结果统计:`, 'info');
        this.log(`✅ 有效: ${stats.valid}`, 'success');
        this.log(`❌ 无效: ${stats.invalid}`, 'error');
        this.log(`⚠️ 重定向: ${stats.redirect}`, 'warning');
        this.log(`⏰ 超时: ${stats.timeout}`, 'warning');
      }

      log(message, type = 'info') {
        const logContainer = document.getElementById('test-log');
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logContainer.appendChild(entry);
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      exitTestMode() {
        // 清除所有状态标签
        const cards = document.querySelectorAll('[data-test-id]');
        cards.forEach(card => {
          // 移除状态类
          card.classList.remove('checking');
          
          // 移除状态标签
          const statusBadge = card.querySelector('.status-badge');
          if (statusBadge) {
            statusBadge.remove();
          }
        });

        // 清空测试结果
        this.testResults.clear();

        this.log('已退出测试模式，清除所有检测状态', 'info');
      }

      clearLog() {
        const logContainer = document.getElementById('test-log');
        logContainer.innerHTML = '<div class="log-entry log-info">日志已清空</div>';
      }
    }

    // 初始化测试管理器
    let testManager;
    document.addEventListener('DOMContentLoaded', () => {
      testManager = new TestManager();
    });
  </script>
</body>
</html>