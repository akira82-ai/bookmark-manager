<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3大指标判定引擎集成测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .test-item {
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .test-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .test-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .status-passed {
            background: #28a745;
        }
        .status-failed {
            background: #dc3545;
        }
        .status-pending {
            background: #6c757d;
        }
        .test-actions {
            margin-top: 15px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            background: #667eea;
            color: white;
        }
        button:hover {
            background: #5a6fd8;
        }
        .test-output {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .integration-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .integration-info h2 {
            color: #1976d2;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧠 3大指标判定引擎集成测试</h1>

        <div class="integration-info">
            <h2>✅ 集成完成情况</h2>
            <p><strong>判定引擎状态：</strong> 已成功集成到书签管理器中</p>
            <p><strong>核心功能：</strong></p>
            <ul>
                <li>✅ 3大指标判定引擎已集成到 content.js</li>
                <li>✅ 智能提醒触发机制已实现</li>
                <li>✅ 调试窗口已更新支持判定结果显示</li>
                <li>✅ 防抖机制已添加（5分钟冷却时间）</li>
                <li>✅ manifest.json 已配置支持判定引擎加载</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>🔍 测试验证步骤</h2>

            <div class="test-item">
                <div class="test-title">1. 判定引擎加载测试</div>
                <div class="test-status status-pending" id="engine-load-status">待测试</div>
                <div class="test-actions">
                    <button onclick="testEngineLoad()">测试引擎加载</button>
                </div>
                <div class="test-output" id="engine-load-output"></div>
            </div>

            <div class="test-item">
                <div class="test-title">2. 核心指标获取测试</div>
                <div class="test-status status-pending" id="metrics-status">待测试</div>
                <div class="test-actions">
                    <button onclick="testMetrics()">测试核心指标</button>
                </div>
                <div class="test-output" id="metrics-output"></div>
            </div>

            <div class="test-item">
                <div class="test-title">3. 判定逻辑测试</div>
                <div class="test-status status-pending" id="judgment-status">待测试</div>
                <div class="test-actions">
                    <button onclick="testJudgment()">测试判定逻辑</button>
                </div>
                <div class="test-output" id="judgment-output"></div>
            </div>

            <div class="test-item">
                <div class="test-title">4. 智能提醒触发测试</div>
                <div class="test-status status-pending" id="reminder-status">待测试</div>
                <div class="test-actions">
                    <button onclick="testReminder()">测试智能提醒</button>
                </div>
                <div class="test-output" id="reminder-output"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>📋 使用说明</h2>
            <div class="test-item">
                <div class="test-title">实际使用步骤</div>
                <ol>
                    <li>在Chrome中加载书签管理器扩展</li>
                    <li>访问任意网页，等待判定引擎加载</li>
                    <li>在页面中右下角会显示调试窗口</li>
                    <li>调试窗口会实时显示3大指标数据</li>
                    <li>当判定达到"高度关注"级别时，会自动触发收藏提醒</li>
                </ol>

                <div class="test-title">调试命令（在浏览器控制台中使用）</div>
                <ul>
                    <li><code>window.testCoreMetrics()</code> - 测试核心指标获取</li>
                    <li><code>window.testSmartReminder()</code> - 测试智能提醒触发</li>
                    <li><code>window.showDebugWindow()</code> - 显示调试窗口</li>
                    <li><code>window.removeDebugWindow()</code> - 移除调试窗口</li>
                </ul>

                <div class="test-title">判定规则说明</div>
                <ul>
                    <li><strong>优先级：</strong> 访问次数 &gt; 访问时长 &gt; 访问深度</li>
                    <li><strong>权重：</strong> 访问次数50%，访问时长30%，访问深度20%</li>
                    <li><strong>触发条件：</strong> 达到"高度关注"级别（Level 2+）</li>
                    <li><strong>冷却时间：</strong> 5分钟内不重复触发</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 测试判定引擎加载
        async function testEngineLoad() {
            const statusEl = document.getElementById('engine-load-status');
            const outputEl = document.getElementById('engine-load-output');

            try {
                // 尝试从Chrome扩展加载判定引擎
                const script = document.createElement('script');
                script.src = chrome.runtime.getURL('metrics-judgment-engine.js');

                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });

                if (window.MetricsJudgmentEngine) {
                    statusEl.textContent = '✅ 通过';
                    statusEl.className = 'test-status status-passed';
                    outputEl.textContent = '判定引擎成功加载\n' +
                        'MetricsJudgmentEngine 类可用\n' +
                        '判定引擎已准备就绪';
                } else {
                    throw new Error('引擎类未找到');
                }
            } catch (error) {
                statusEl.textContent = '❌ 失败';
                statusEl.className = 'test-status status-failed';
                outputEl.textContent = '错误: ' + error.message + '\n' +
                    '请确保：\n' +
                    '1. 在Chrome扩展环境中运行\n' +
                    '2. metrics-judgment-engine.js文件存在\n' +
                    '3. manifest.json已正确配置';
            }
        }

        // 测试核心指标获取
        async function testMetrics() {
            const statusEl = document.getElementById('metrics-status');
            const outputEl = document.getElementById('metrics-output');

            try {
                if (!window.MetricsJudgmentEngine) {
                    throw new Error('判定引擎未加载');
                }

                // 模拟核心指标数据
                const mockMetrics = {
                    visitCount: 8,
                    browseDuration: 95,
                    browseDepth: 4.2
                };

                const engine = new window.MetricsJudgmentEngine();
                const result = engine.judge(mockMetrics);

                statusEl.textContent = '✅ 通过';
                statusEl.className = 'test-status status-passed';
                outputEl.textContent = '测试数据: ' + JSON.stringify(mockMetrics, null, 2) + '\n\n' +
                    '判定结果: ' + JSON.stringify({
                        passed: result.passed,
                        level: result.level,
                        levelName: result.levelName,
                        weightedScore: result.weightedScore,
                        confidence: result.confidence
                    }, null, 2);
            } catch (error) {
                statusEl.textContent = '❌ 失败';
                statusEl.className = 'test-status status-failed';
                outputEl.textContent = '错误: ' + error.message;
            }
        }

        // 测试判定逻辑
        async function testJudgment() {
            const statusEl = document.getElementById('judgment-status');
            const outputEl = document.getElementById('judgment-output');

            try {
                if (!window.MetricsJudgmentEngine) {
                    throw new Error('判定引擎未加载');
                }

                const engine = new window.MetricsJudgmentEngine();
                const testCases = [
                    { name: '低关注', data: { visitCount: 2, browseDuration: 25, browseDepth: 1.0 } },
                    { name: '基础关注', data: { visitCount: 4, browseDuration: 45, browseDepth: 2.0 } },
                    { name: '高度关注', data: { visitCount: 10, browseDuration: 100, browseDepth: 6.0 } },
                    { name: '极度关注', data: { visitCount: 25, browseDuration: 200, browseDepth: 15.0 } }
                ];

                let results = '';
                testCases.forEach(testCase => {
                    const result = engine.judge(testCase.data);
                    results += `${testCase.name}: ${result.levelName} (分数: ${result.weightedScore.toFixed(2)})\n`;
                });

                statusEl.textContent = '✅ 通过';
                statusEl.className = 'test-status status-passed';
                outputEl.textContent = results;
            } catch (error) {
                statusEl.textContent = '❌ 失败';
                statusEl.className = 'test-status status-failed';
                outputEl.textContent = '错误: ' + error.message;
            }
        }

        // 测试智能提醒
        async function testReminder() {
            const statusEl = document.getElementById('reminder-status');
            const outputEl = document.getElementById('reminder-output');

            try {
                if (!window.MetricsJudgmentEngine) {
                    throw new Error('判定引擎未加载');
                }

                // 创建模拟数据
                const mockMetrics = {
                    visitCount: 12,
                    browseDuration: 120,
                    browseDepth: 8.0
                };

                const engine = new window.MetricsJudgmentEngine();
                const result = engine.judge(mockMetrics);

                statusEl.textContent = '✅ 通过';
                statusEl.className = 'test-status status-passed';
                outputEl.textContent = '智能提醒触发条件验证:\n\n' +
                    '测试数据: ' + JSON.stringify(mockMetrics, null, 2) + '\n\n' +
                    '判定结果:\n' +
                    `- 通过判定: ${result.passed ? '是' : '否'}\n` +
                    `- 关注级别: ${result.levelName}\n` +
                    `- 分数: ${result.weightedScore.toFixed(2)}/4.0\n` +
                    `- 置信度: ${(result.confidence * 100).toFixed(1)}%\n\n` +
                    '提醒触发: ' + (result.level >= 2 ? '✅ 会触发' : '❌ 不会触发');
            } catch (error) {
                statusEl.textContent = '❌ 失败';
                statusEl.className = 'test-status status-failed';
                outputEl.textContent = '错误: ' + error.message;
            }
        }

        // 页面加载时的初始化
        window.addEventListener('load', function() {
            console.log('3大指标判定引擎集成测试页面已加载');
        });
    </script>
</body>
</html>